generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  waitlists Waitlist[]
}

model Waitlist {
  id          String           @id @default(cuid())
  name        String
  slug        String           @unique
  description String?
  settings    Json             @default("{}")
  ownerId     String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  events      AnalyticsEvent[]
  rewards     Reward[]
  signups     Signup[]
  owner       User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
}

model Signup {
  id              String    @id @default(cuid())
  waitlistId      String
  email           String
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  verifyToken     String?   @unique
  position        Int
  referralCode    String    @unique
  referredBy      String?
  referralCount   Int       @default(0)
  ipAddress       String?
  userAgent       String?
  referrerUrl     String?
  fraudFlags      Json?
  engagementScore Int       @default(0)
  emailOpens      Int       @default(0)
  linkClicks      Int       @default(0)
  invited         Boolean   @default(false)
  invitedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  waitlist        Waitlist  @relation(fields: [waitlistId], references: [id], onDelete: Cascade)

  @@unique([waitlistId, email])
  @@index([waitlistId, referralCount(sort: Desc)])
  @@index([waitlistId, verified])
  @@index([waitlistId, position])
  @@index([referralCode])
  @@index([referredBy])
}

model Reward {
  id          String   @id @default(cuid())
  waitlistId  String
  threshold   Int
  title       String
  description String
  createdAt   DateTime @default(now())
  waitlist    Waitlist @relation(fields: [waitlistId], references: [id], onDelete: Cascade)

  @@index([waitlistId, threshold])
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  waitlistId String
  type       String
  signupId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  waitlist   Waitlist @relation(fields: [waitlistId], references: [id], onDelete: Cascade)

  @@index([waitlistId, type])
  @@index([waitlistId, createdAt])
}
